name: Enhanced Security Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: read
  actions: read

jobs:
  comprehensive-security-scan:
    runs-on: ubuntu-latest
    name: Multi-Tool Security Analysis
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/
        continue-on-error: true

      - name: Terraform Validation
        run: |
          cd terraform/environments/dev
          terraform init -backend=false
          terraform validate
        continue-on-error: true

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
      
      - name: Init TFLint
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Run TFLint
        run: tflint --recursive --format=compact terraform/
        continue-on-error: true

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform
          soft_fail: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          soft_fail: true
          download_external_modules: true
          skip_check: CKV_AWS_79,CKV_AWS_144

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'terraform'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: OPA Policy Validation
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x opa
          if [ -f "policies/opa/policy.rego" ]; then
            ./opa test policies/opa/ -v || echo "OPA tests completed"
          else
            echo "No OPA policies found, skipping..."
          fi
        continue-on-error: true

      - name: Security Scan Summary
        if: always()
        run: |
          echo "âœ… Security scan completed!"
          echo "Check the logs above for detailed findings from:"
          echo "  - Terraform validation"
          echo "  - TFLint"
          echo "  - tfsec"
          echo "  - Checkov"
          echo "  - Trivy"
          echo "  - OPA policy validation"

  dependency-scan:
    runs-on: ubuntu-latest
    name: Dependency Vulnerability Scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan Python Dependencies
        run: |
          if find . -name requirements.txt | grep -q .; then
            pip install safety
            find . -name requirements.txt -exec safety check -r {} \; || true
          else
            echo "No requirements.txt files found"
          fi
        continue-on-error: true
